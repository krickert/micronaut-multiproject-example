FROM eclipse-temurin:21-jre-alpine

# Install supervisor and utilities
RUN apk add --no-cache supervisor bash curl wget

# Create directories
RUN mkdir -p /app/engine /app/modules /var/log/supervisor /var/run

# Copy the application JAR (this will include both engine and tika-parser)
COPY libs/*.jar /home/app/application.jar

# Copy the tika-parser module JAR separately
COPY libs/tika-parser-*.jar /app/modules/tika-parser.jar

# Copy configuration files
COPY config/supervisord.conf /etc/supervisor/conf.d/
COPY config/application.yml /app/engine/
COPY config/module-application.yml /app/modules/application.yml
COPY config/start.sh /app/start.sh

# Make start script executable
RUN chmod +x /app/start.sh

# Expose ports: Engine HTTP, Engine gRPC, Tika Parser gRPC
EXPOSE 8080 50051 50053

USER root
CMD ["/app/start.sh"]